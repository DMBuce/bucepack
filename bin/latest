#!/bin/bash

# get latest minecraft version if latest.txt is over a day old
if [[ ! -f latest.txt ]] || find latest.txt -mtime +1 | grep -q .; then
	curl -s 'https://launchermeta.mojang.com/mc/game/version_manifest.json' \
	| jq -r .latest.release \
	> latest.txt
fi

# create folder with jar contents if necessary
latest="$(<latest.txt)"
if [[ ! -f ~/".minecraft/versions/$latest/$latest.jar" ]]; then
	echo "File not found: ~/.minecraft/versions/$latest/$latest.jar" >&2
	exit 1
elif [[ ! -d "$latest.jar" ]]; then
	mkdir "$latest.jar"
	cd "$latest.jar"
	jar xf ~/".minecraft/versions/$latest/$latest.jar" assets data version.json
	rm */.mcassetsroot
	cd -
fi

# copy sounds.json
if [[ ! -f ~/".minecraft/assets/indexes/${latest%.*}.json" ]]; then
	echo "File not found: ~/.minecraft/assets/indexes/${latest%.*}.json" >&2
	exit 1
elif [[ ! -f "$latest.jar/assets/minecraft/sounds.json" ]]; then
	soundhash="$(jq -r '.objects."minecraft/sounds.json".hash' ~/.minecraft/assets/indexes/1.19.json)"
	cp -v ~/".minecraft/assets/objects/${soundhash:0:2}/$soundhash" "$latest.jar/assets/minecraft/sounds.json" >&2
fi

## copy missing data files from mcmeta repo
#cd ../mcmeta
#branch="$(git branch --show-current)"
#if [[ $branch != $latest-data ]]; then
#	git pull --tags
#	git checkout -b "$latest-data" "$latest-data"
#	cd -
#	rsync -a ../mcmeta/data/minecraft/dimension/ "$latest.jar/data/minecraft/dimension/"
#fi

# print latest version
echo "$latest"

